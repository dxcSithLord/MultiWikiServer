<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Users - MWS Admin</title>
  <link rel="stylesheet" href="{{pathPrefix}}/admin-htmx/styles.css">
</head>
<body>
  <!-- Navigation -->
  <nav class="mws-admin-navbar">
    <h1>
      <strong>MWS Admin</strong>
      <small>(HTMX)</small>
    </h1>
    <div class="mws-admin-nav-right">
      <a href="{{pathPrefix}}/admin">Switch to React Admin</a>

      <!-- User Dropdown -->
      <div class="mws-user-dropdown">
        <button class="mws-btn mws-btn-secondary" id="user-menu-btn">
          <span>{{username}}</span>
          <span style="margin-left: 0.5rem;">â–¼</span>
        </button>
        <div class="mws-dropdown-menu" id="user-menu">
          <a href="{{pathPrefix}}/admin-htmx/profile" class="mws-dropdown-item">
            <span>ðŸ‘¤</span> Profile
          </a>
          <div class="mws-dropdown-divider"></div>
          <button id="logout-btn" class="mws-dropdown-item">
            <span>ðŸšª</span> Logout
          </button>
          <div class="mws-dropdown-divider"></div>
          <div class="mws-dropdown-item disabled" style="font-size: 0.8rem; color: #757575;">
            <div>TW5: <span id="tw5-version">--</span></div>
            <div>MWS: <span id="mws-version">--</span></div>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="mws-admin-container">
    <div class="mws-admin-card">
      <div class="mws-admin-card-header">
        <h2>Users</h2>
        <button id="create-user-btn" class="mws-btn mws-btn-primary">
          Create New User
        </button>
      </div>
      <table id="users-table" class="mws-admin-table">
        <thead>
          <tr>
            <th>Username</th>
            <th>Email</th>
            <th>Roles</th>
            <th>Last Login</th>
            <th>Created</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="users-tbody">
          <tr>
            <td colspan="6" class="mws-loading">
              <div class="mws-spinner"></div>
              <div>Loading users...</div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Create/Edit User Modal -->
  <div id="userModal" class="mws-modal">
    <div class="mws-modal-content">
      <div class="mws-modal-header">
        <h3 id="modal-title">Create User</h3>
        <button class="mws-btn mws-btn-sm" data-action="close-modal" aria-label="Close">&times;</button>
      </div>
      <div class="mws-modal-body">
        <form id="userForm" onsubmit="handleUserSubmit(event)">
          <input type="hidden" id="user_id" name="user_id">

          <div class="mws-form-group">
            <label for="username">Username</label>
            <input type="text" id="username" name="username" class="mws-form-input" required>
          </div>

          <div class="mws-form-group">
            <label for="email">Email</label>
            <input type="email" id="email" name="email" class="mws-form-input" required>
          </div>

          <div class="mws-form-group">
            <label for="roles">Roles (Hold Ctrl/Cmd for multiple)</label>
            <select id="roles" name="role_ids" class="mws-form-select" multiple size="3">
              <!-- Populated dynamically -->
            </select>
          </div>

          <div class="mws-form-group" id="password-section" style="display:none;">
            <label>Temporary Password</label>
            <button type="button" class="mws-btn mws-btn-secondary" id="generate-temp-password-btn">
              Generate Temporary Password
            </button>
            <small class="mws-text-muted" style="display:block;margin-top:0.5rem;">
              Generates a random password that will be shown once
            </small>
          </div>

          <div class="mws-modal-footer">
            <button type="button" class="mws-btn mws-btn-secondary" data-action="close-modal">Cancel</button>
            <button type="submit" class="mws-btn mws-btn-primary">
              <span id="submit-spinner" class="mws-spinner" style="display:none;"></span>
              <span id="submit-text">Create User</span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Temporary Password Modal -->
  <div id="tempPasswordModal" class="mws-modal">
    <div class="mws-modal-content" style="max-width: 500px;">
      <div class="mws-modal-header">
        <h3>Temporary Password Generated</h3>
        <button class="mws-btn mws-btn-sm" data-action="close-temp-password-modal" aria-label="Close">&times;</button>
      </div>
      <div class="mws-modal-body">
        <p><strong>Important:</strong> This password will only be shown once. Copy it now and send it to the user securely.</p>
        <div style="background: #f5f5f5; padding: 1rem; border-radius: 4px; margin: 1rem 0; font-family: monospace; font-size: 1.2rem; text-align: center; word-break: break-all;">
          <span id="temp-password-display"></span>
        </div>
        <button type="button" class="mws-btn mws-btn-secondary" id="copy-temp-password-btn" style="width: 100%;">
          Copy to Clipboard
        </button>
      </div>
      <div class="mws-modal-footer">
        <button type="button" class="mws-btn mws-btn-primary" data-action="close-temp-password-modal">Close</button>
      </div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div id="toast" class="mws-toast">
    <span id="toast-message"></span>
    <button class="mws-btn mws-btn-sm" id="toast-close-btn" aria-label="Close">&times;</button>
  </div>

  <script>
    const pathPrefix = '{{pathPrefix}}';
    let allRoles = [];
    let allUsers = [];

    // Utility: Make API request
    async function apiRequest(endpoint, data) {
      const response = await fetch(pathPrefix + '/admin/' + endpoint, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Requested-With': 'TiddlyWiki'
        },
        body: JSON.stringify(data)
      });

      // Handle session expiry
      if (response.status === 401) {
        const currentPath = window.location.pathname;
        window.location.href = pathPrefix + '/login?redirect=' + encodeURIComponent(currentPath);
        throw new Error('Session expired. Redirecting to login...');
      }

      if (!response.ok) {
        let errorMessage = 'An error occurred. Please try again.';

        try {
          // Read response as text first
          const text = await response.text();

          // Try to parse as JSON
          try {
            const errorData = JSON.parse(text);
            if (errorData.reason && typeof errorData.reason === 'string') {
              errorMessage = errorData.reason;
            } else if (errorData.message && typeof errorData.message === 'string') {
              errorMessage = errorData.message;
            }
          } catch (jsonError) {
            // Not JSON, use text if it's short
            if (text && text.length < 200) {
              errorMessage = text;
            }
          }
        } catch (e) {
          // Failed to read response at all
          console.error('Failed to read error response:', e);
        }

        throw new Error(errorMessage);
      }

      return response.json();
    }

    // Load users on page load
    async function loadUsers() {
      try {
        allUsers = await apiRequest('user_list', undefined);
        renderUsers();
      } catch (error) {
        showToast('Failed to load users: ' + error.message, 'error');
      }
    }

    // Render users table
    function renderUsers() {
      const tbody = document.getElementById('users-tbody');

      if (allUsers.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;" class="mws-text-muted">No users found</td></tr>';
        return;
      }

      tbody.innerHTML = allUsers.map(user => `
        <tr id="user-${escapeHtml(user.user_id)}">
          <td><strong>${escapeHtml(user.username)}</strong></td>
          <td>${escapeHtml(user.email)}</td>
          <td>
            ${user.roles.map(role => `<span class="mws-badge">${escapeHtml(role.role_name)}</span>`).join('')}
          </td>
          <td>${user.last_login ? formatDate(user.last_login) : '<span class="mws-text-muted">Never</span>'}</td>
          <td>${formatDate(user.created_at)}</td>
          <td>
            <div class="mws-btn-group">
              <button class="mws-btn mws-btn-primary mws-btn-sm" data-action="edit" data-user-id="${escapeHtml(user.user_id)}">Edit</button>
              <button class="mws-btn mws-btn-danger mws-btn-sm" data-action="delete" data-user-id="${escapeHtml(user.user_id)}" data-username="${escapeHtml(user.username)}">Delete</button>
            </div>
          </td>
        </tr>
      `).join('');
    }

    // Load all roles for the form
    async function loadRoles() {
      try {
        // Get roles and other data from index endpoint
        const data = await apiRequest('index_json', undefined);
        allRoles = data.roleList || [];

        // Update version info in dropdown
        if (data.versions) {
          document.getElementById('tw5-version').textContent = data.versions.tw5 || '--';
          document.getElementById('mws-version').textContent = data.versions.mws || '--';
        }

        // Check if user is admin
        if (!data.isAdmin) {
          showToast('Admin access required to manage users', 'error');
          document.getElementById('users-tbody').innerHTML =
            '<tr><td colspan="6" style="text-align: center;" class="mws-text-muted">Admin access required</td></tr>';
          return false;
        }
        return true;
      } catch (error) {
        console.error('Failed to load roles:', error);
        showToast('Failed to initialize: ' + error.message, 'error');
        return false;
      }
    }

    // Show create modal
    function showCreateModal() {
      document.getElementById('modal-title').textContent = 'Create User';
      document.getElementById('submit-text').textContent = 'Create User';
      document.getElementById('userForm').reset();
      document.getElementById('user_id').value = '';
      populateRoles([]);
      document.getElementById('password-section').style.display = 'none';
      document.getElementById('userModal').classList.add('mws-show');
    }

    // Show edit modal
    async function showEditModal(userId) {
      try {
        const data = await apiRequest('user_edit_data', { user_id: userId });

        document.getElementById('modal-title').textContent = 'Edit User';
        document.getElementById('submit-text').textContent = 'Update User';
        document.getElementById('user_id').value = data.user.user_id;
        document.getElementById('username').value = data.user.username;
        document.getElementById('email').value = data.user.email;

        allRoles = data.allRoles;
        populateRoles(data.user.roles.map(r => r.role_id));

        // Show password section for editing
        document.getElementById('password-section').style.display = 'block';

        document.getElementById('userModal').classList.add('mws-show');
      } catch (error) {
        showToast('Failed to load user: ' + error.message, 'error');
      }
    }

    // Populate roles dropdown
    function populateRoles(selectedIds = []) {
      const select = document.getElementById('roles');
      select.innerHTML = allRoles.map(role =>
        `<option value="${role.role_id}" ${selectedIds.includes(role.role_id) ? 'selected' : ''}>
          ${escapeHtml(role.role_name)} - ${escapeHtml(role.description)}
        </option>`
      ).join('');
    }

    // Close modal
    function closeModal() {
      document.getElementById('userModal').classList.remove('mws-show');
    }

    // Close temp password modal
    function closeTempPasswordModal() {
      document.getElementById('tempPasswordModal').classList.remove('mws-show');
    }

    // Generate temporary password
    async function generateTempPassword() {
      const userId = document.getElementById('user_id').value;
      if (!userId) {
        showToast('Please save the user first before generating a password', 'error');
        return;
      }

      try {
        const result = await apiRequest('user_generate_temp_password', { user_id: userId });

        // Show the temporary password in a modal
        document.getElementById('temp-password-display').textContent = result.temporaryPassword;
        document.getElementById('tempPasswordModal').classList.add('mws-show');

        showToast('Temporary password generated successfully', 'success');
      } catch (error) {
        showToast('Failed to generate password: ' + error.message, 'error');
      }
    }

    // Copy temporary password to clipboard
    async function copyTempPassword() {
      const password = document.getElementById('temp-password-display').textContent;
      try {
        await navigator.clipboard.writeText(password);
        showToast('Password copied to clipboard', 'success');
      } catch (error) {
        // Fallback for older browsers
        const textarea = document.createElement('textarea');
        textarea.value = password;
        textarea.style.position = 'fixed';
        textarea.style.opacity = '0';
        document.body.appendChild(textarea);
        textarea.select();
        try {
          document.execCommand('copy');
          showToast('Password copied to clipboard', 'success');
        } catch (e) {
          showToast('Failed to copy password', 'error');
        }
        document.body.removeChild(textarea);
      }
    }

    // Handle form submission
    async function handleUserSubmit(event) {
      event.preventDefault();

      const spinner = document.getElementById('submit-spinner');
      const submitBtn = event.target.querySelector('button[type="submit"]');

      spinner.style.display = 'inline-block';
      submitBtn.disabled = true;

      try {
        const formData = new FormData(event.target);
        const userId = formData.get('user_id');
        const username = formData.get('username');
        const email = formData.get('email');
        const role_ids = formData.getAll('role_ids');

        if (userId) {
          // Update existing user
          await apiRequest('user_update', { user_id: userId, username, email, role_ids });
          showToast('User updated successfully', 'success');
        } else {
          // Create new user
          await apiRequest('user_create', { username, email, role_ids });
          showToast('User created successfully', 'success');
        }

        closeModal();
        await loadUsers();
      } catch (error) {
        showToast('Failed to save user: ' + error.message, 'error');
      } finally {
        spinner.style.display = 'none';
        submitBtn.disabled = false;
      }
    }

    // Delete user
    async function deleteUser(userId, username) {
      if (!confirm(`Are you sure you want to delete user '${username}'?`)) {
        return;
      }

      try {
        await apiRequest('user_delete', { user_id: userId });
        showToast('User deleted successfully', 'success');
        await loadUsers();
      } catch (error) {
        showToast('Failed to delete user: ' + error.message, 'error');
      }
    }

    // Show toast notification
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      const messageEl = document.getElementById('toast-message');

      messageEl.textContent = message;
      toast.className = `mws-toast mws-show mws-${type}`;

      setTimeout(() => hideToast(), 5000);
    }

    // Hide toast
    function hideToast() {
      document.getElementById('toast').classList.remove('mws-show');
    }

    // Utility functions
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatDate(dateString) {
      return new Date(dateString).toLocaleDateString();
    }

    // Event delegation for user action buttons (moved to DOMContentLoaded below)

    // Initialize all event listeners on DOMContentLoaded
    document.addEventListener('DOMContentLoaded', async () => {
      // Check URL parameters for auto-opening edit modal (for profile)
      const urlParams = new URLSearchParams(window.location.search);
      const editUserId = urlParams.get('editUser');

      // Create user button
      const createUserBtn = document.getElementById('create-user-btn');
      if (createUserBtn) {
        createUserBtn.addEventListener('click', showCreateModal);
      }

      // Close toast button
      const toastCloseBtn = document.getElementById('toast-close-btn');
      if (toastCloseBtn) {
        toastCloseBtn.addEventListener('click', hideToast);
      }

      // User menu button handler
      const userMenuBtn = document.getElementById('user-menu-btn');
      const userMenu = document.getElementById('user-menu');

      if (userMenuBtn && userMenu) {
        userMenuBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          userMenu.classList.toggle('mws-show');
        });
      }

      // Logout button handler
      const logoutBtn = document.getElementById('logout-btn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', async () => {
          try {
            const response = await fetch(pathPrefix + '/logout', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'TiddlyWiki'
              },
              body: JSON.stringify(undefined)
            });

            if (response.ok) {
              window.location.href = pathPrefix + '/';
            } else {
              // Even on failure, redirect to login for security
              showToast('Logout encountered an issue. Redirecting to login...', 'error');
              setTimeout(() => {
                window.location.href = pathPrefix + '/login';
              }, 2000);
            }
          } catch (error) {
            console.error('Logout error:', error);
            showToast('Network error during logout. Please try again.', 'error');
          }
        });
      }

      // Close dropdown when clicking outside
      document.addEventListener('click', (e) => {
        const dropdown = document.querySelector('.mws-user-dropdown');
        if (dropdown && userMenu && !dropdown.contains(e.target)) {
          userMenu.classList.remove('mws-show');
        }
      });

      // Close modal buttons (event delegation)
      document.addEventListener('click', (e) => {
        if (e.target.closest('[data-action="close-modal"]')) {
          closeModal();
        }
        if (e.target.closest('[data-action="close-temp-password-modal"]')) {
          closeTempPasswordModal();
        }
      });

      // Generate temporary password button
      const generateTempPasswordBtn = document.getElementById('generate-temp-password-btn');
      if (generateTempPasswordBtn) {
        generateTempPasswordBtn.addEventListener('click', generateTempPassword);
      }

      // Copy temporary password button
      const copyTempPasswordBtn = document.getElementById('copy-temp-password-btn');
      if (copyTempPasswordBtn) {
        copyTempPasswordBtn.addEventListener('click', copyTempPassword);
      }

      // Close temp password modal when clicking backdrop
      const tempPasswordModal = document.getElementById('tempPasswordModal');
      if (tempPasswordModal) {
        tempPasswordModal.addEventListener('click', (e) => {
          if (e.target === e.currentTarget) {
            closeTempPasswordModal();
          }
        });
      }

      // Event delegation for user action buttons
      const usersTbody = document.getElementById('users-tbody');
      if (usersTbody) {
        usersTbody.addEventListener('click', (e) => {
          const target = e.target;
          if (target.tagName === 'BUTTON' && target.dataset.action) {
            const action = target.dataset.action;
            const userId = target.dataset.userId;

            if (action === 'edit' && userId) {
              showEditModal(userId);
            } else if (action === 'delete' && userId) {
              const username = target.dataset.username;
              deleteUser(userId, username);
            }
          }
        });
      }

      // Close modal when clicking backdrop
      const userModal = document.getElementById('userModal');
      if (userModal) {
        userModal.addEventListener('click', (e) => {
          if (e.target === e.currentTarget) {
            closeModal();
          }
        });
      }

      // Load initial data
      const hasAccess = await loadRoles();
      if (hasAccess) {
        await loadUsers();

        // Auto-open edit modal if editUser parameter is present (for profile)
        if (editUserId) {
          showEditModal(editUserId);
        }
      }
    });
  </script>
</body>
</html>
